<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">My Tile Dashboard</title>
    <link id="pageFavicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé®</text></svg>">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header Section */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .header-logo:hover {
            transform: scale(1.05);
        }

        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }

        .header h1 {
            font-size: 28px;
            color: white;
            margin: 0;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: white;
            color: #667eea;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.2s;
            border: none;
        }

        .header-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            background: #f8f9fa;
        }

        .header-btn:active {
            transform: translateY(0);
        }

        /* Tile Grid */
        .tiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        /* Tile Card */
        .tile {
            background: white;
            border-radius: 14px;
            padding: 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            animation: fadeIn 0.4s ease-out;
            cursor: grab;
        }

        .tile.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: scale(0.95);
        }

        .tile.drag-over {
            border: 2px dashed #667eea;
            background: #f0f4ff;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tile:hover:not(.dragging) {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        .tile-drag-handle {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(102, 126, 234, 0.9);
            color: white;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
            cursor: grab;
        }

        .tile:hover .tile-drag-handle {
            opacity: 1;
        }

        .tile-drag-handle:active {
            cursor: grabbing;
        }

        .tile-image-container {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }

        .tile-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
        }

        .tile-placeholder-image {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 40px;
            cursor: pointer;
        }

        .tile-content {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .tile-title {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 4px;
            transition: background 0.2s;
            word-wrap: break-word;
            line-height: 1.3;
        }

        .tile-title:hover {
            background: #f8f9fa;
        }

        .tile-subtitle {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 3px 6px;
            border-radius: 4px;
            transition: background 0.2s;
            flex-grow: 1;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .tile-subtitle:hover {
            background: #f8f9fa;
        }

        .tile-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .tile-button:hover {
            background: #5568d3;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.4);
        }

        .tile-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(220, 53, 69, 0.9);
            color: white;
            border: none;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .tile:hover .tile-delete {
            opacity: 1;
        }

        .tile-delete:hover {
            background: rgba(200, 35, 51, 1);
        }

        /* New Tile Button */
        .new-tile {
            background: rgba(255, 255, 255, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.6);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 220px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .new-tile:hover {
            background: rgba(255, 255, 255, 0.4);
            border-color: white;
            transform: translateY(-4px);
        }

        .new-tile-content {
            text-align: center;
            color: white;
        }

        .new-tile-icon {
            font-size: 40px;
            margin-bottom: 6px;
        }

        .new-tile-text {
            font-size: 14px;
            font-weight: 600;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 450px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 18px;
            color: #333;
        }

        .modal-close {
            position: absolute;
            top: 18px;
            right: 18px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 13px;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea.form-input {
            resize: vertical;
            min-height: 70px;
        }

        .form-hint {
            font-size: 11px;
            color: #666;
            margin-top: 5px;
            line-height: 1.4;
        }

        .form-hint a {
            color: #667eea;
            text-decoration: none;
        }

        .form-hint a:hover {
            text-decoration: underline;
        }

        .form-hint-icon {
            display: inline-block;
            margin-right: 3px;
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 11px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #28a745;
            color: white;
            padding: 14px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 2000;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toast.show {
            display: flex;
        }

        /* Utility */
        .hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .tiles-grid {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 12px;
            }

            .header h1 {
                font-size: 20px;
            }

            .header-logo {
                width: 40px;
                height: 40px;
                font-size: 22px;
            }

            .tile-image-container {
                height: 100px;
            }

            .new-tile {
                min-height: 180px;
            }
        }

        @media (min-width: 1400px) {
            .tiles-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Simplified Header -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo" id="headerLogo" onclick="openPageSettingsModal()">
                    üé®
                </div>
                <h1 id="mainTitle" onclick="openPageSettingsModal()">My Tile Dashboard</h1>
            </div>

            <div class="header-controls">
                <button class="header-btn" onclick="shareURL()" title="Share URL">üîó</button>
                <button class="header-btn" onclick="openPageSettingsModal()" title="Settings">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- Tiles Grid -->
        <div class="tiles-grid" id="tilesGrid">
            <!-- New Tile Button -->
            <div class="new-tile" onclick="openNewTileModal()">
                <div class="new-tile-content">
                    <div class="new-tile-icon">+</div>
                    <div class="new-tile-text">Add New Tile</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage">URL copied to clipboard!</span>
    </div>

    <!-- Tile Modal -->
    <div class="modal" id="tileModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeTileModal()">√ó</button>
            <div class="modal-header" id="tileModalHeader">New Tile</div>

            <div class="form-group">
                <label class="form-label">Title</label>
                <input type="text" class="form-input" id="tileTitle" placeholder="Enter tile title">
            </div>

            <div class="form-group">
                <label class="form-label">Subtitle</label>
                <textarea class="form-input" id="tileSubtitle" placeholder="Enter tile subtitle or description"></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">Image URL</label>
                <input type="text" class="form-input" id="tileImage" placeholder="https://i.imgur.com/example.jpg">
                <div class="form-hint">
                    <span class="form-hint-icon">üí°</span>Shorter URLs work better. Use <a href="https://imgur.com/upload" target="_blank">Imgur</a> or similar services. Right-click on an image and select "Copy image link" to get the direct image URL.
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Button Text</label>
                <input type="text" class="form-input" id="tileButtonText" placeholder="Learn More">
            </div>

            <div class="form-group">
                <label class="form-label">Button Link (Optional)</label>
                <input type="text" class="form-input" id="tileButtonLink" placeholder="https://example.com">
                <div class="form-hint">
                    <span class="form-hint-icon">üí°</span>Shorter URLs help keep your dashboard shareable.
                </div>
            </div>

            <div class="form-buttons">
                <button class="btn btn-secondary" onclick="closeTileModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveTile()">Save Tile</button>
            </div>
        </div>
    </div>

    <!-- Page Settings Modal -->
    <div class="modal" id="pageSettingsModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closePageSettingsModal()">√ó</button>
            <div class="modal-header">Page Settings</div>

            <div class="form-group">
                <label class="form-label">Page Title</label>
                <input type="text" class="form-input" id="pageSettingsTitle" placeholder="My Tile Dashboard">
            </div>

            <div class="form-group">
                <label class="form-label">Logo (Emoji or Image URL)</label>
                <input type="text" class="form-input" id="pageSettingsLogo" placeholder="üé® or https://example.com/logo.png">
                <div class="form-hint">
                    <span class="form-hint-icon">üí°</span>Use an emoji or a short image URL for best results.
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Favicon (Emoji or URL)</label>
                <input type="text" class="form-input" id="pageSettingsFavicon" placeholder="üé® or https://example.com/favicon.ico">
                <div class="form-hint">
                    <span class="form-hint-icon">üí°</span>Emoji favicons work great and don't add URL length.
                </div>
            </div>

            <div class="form-buttons">
                <button class="btn btn-secondary" onclick="closePageSettingsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePageSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <script>
        let tiles = [];
        let editingTileIndex = null;
        let pageSettings = {
            title: 'My Tile Dashboard',
            logo: 'üé®',
            favicon: 'üé®'
        };

        // Drag and drop state
        let draggedTileIndex = null;

        // Abbreviated key mapping for URL compression
        const KEYS = {
            TITLE: 't',
            SUBTITLE: 's',
            IMAGE: 'i',
            BUTTON_TEXT: 'b',
            BUTTON_LINK: 'l'
        };

        // Convert tiles to abbreviated format for URL
        function tilesToAbbreviated(tiles) {
            return tiles.map(tile => ({
                [KEYS.TITLE]: tile.title,
                [KEYS.SUBTITLE]: tile.subtitle,
                [KEYS.IMAGE]: tile.image,
                [KEYS.BUTTON_TEXT]: tile.buttonText,
                [KEYS.BUTTON_LINK]: tile.buttonLink
            }));
        }

        // Convert abbreviated format back to full format
        function abbreviatedToTiles(abbreviated) {
            return abbreviated.map(tile => ({
                title: tile[KEYS.TITLE] || '',
                subtitle: tile[KEYS.SUBTITLE] || '',
                image: tile[KEYS.IMAGE] || '',
                buttonText: tile[KEYS.BUTTON_TEXT] || 'Learn More',
                buttonLink: tile[KEYS.BUTTON_LINK] || ''
            }));
        }

        // Load from URL
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);

            if (params.has('pt')) {
                pageSettings.title = params.get('pt');
            }
            if (params.has('lg')) {
                pageSettings.logo = params.get('lg');
            }
            if (params.has('fv')) {
                pageSettings.favicon = params.get('fv');
            }

            applyPageSettings();

            const tilesData = params.get('d');
            if (tilesData) {
                try {
                    const abbreviated = JSON.parse(tilesData);
                    tiles = abbreviatedToTiles(abbreviated);
                } catch (e) {
                    console.error('Error parsing tiles data:', e);
                    const legacyData = params.get('tiles');
                    if (legacyData) {
                        try {
                            tiles = JSON.parse(decodeURIComponent(legacyData));
                        } catch (e2) {
                            console.error('Error parsing legacy tiles data:', e2);
                        }
                    }
                }
            }

            renderTiles();
        }

        // Apply page settings
        function applyPageSettings() {
            document.getElementById('pageTitle').textContent = pageSettings.title;
            document.getElementById('mainTitle').textContent = pageSettings.title;
            document.title = pageSettings.title;

            const logoDiv = document.getElementById('headerLogo');
            if (pageSettings.logo.startsWith('http')) {
                logoDiv.innerHTML = `<img src="${escapeHtml(pageSettings.logo)}" alt="Logo">`;
            } else {
                logoDiv.textContent = pageSettings.logo;
            }

            const favicon = document.getElementById('pageFavicon');
            if (pageSettings.favicon.startsWith('http')) {
                favicon.href = pageSettings.favicon;
            } else {
                favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>${encodeURIComponent(pageSettings.favicon)}</text></svg>`;
            }
        }

        // Share URL
        function shareURL() {
            const url = window.location.href;
            const urlLength = url.length;

            navigator.clipboard.writeText(url).then(() => {
                showToast(`URL copied! (${urlLength} chars)`);
            }).catch(() => {
                const textArea = document.createElement('textarea');
                textArea.value = url;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast(`URL copied! (${urlLength} chars)`);
                } catch (err) {
                    prompt('Copy this URL:', url);
                }
                document.body.removeChild(textArea);
            });
        }

        // Show toast notification
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Open page settings modal
        function openPageSettingsModal() {
            document.getElementById('pageSettingsTitle').value = pageSettings.title;
            document.getElementById('pageSettingsLogo').value = pageSettings.logo;
            document.getElementById('pageSettingsFavicon').value = pageSettings.favicon;
            document.getElementById('pageSettingsModal').classList.add('active');
        }

        // Close page settings modal
        function closePageSettingsModal() {
            document.getElementById('pageSettingsModal').classList.remove('active');
        }

        // Save page settings
        function savePageSettings() {
            pageSettings.title = document.getElementById('pageSettingsTitle').value || 'My Tile Dashboard';
            pageSettings.logo = document.getElementById('pageSettingsLogo').value || 'üé®';
            pageSettings.favicon = document.getElementById('pageSettingsFavicon').value || 'üé®';

            applyPageSettings();
            updateURL();
            closePageSettingsModal();
        }

        // Open new tile modal
        function openNewTileModal() {
            editingTileIndex = null;
            document.getElementById('tileModalHeader').textContent = 'New Tile';
            document.getElementById('tileTitle').value = '';
            document.getElementById('tileSubtitle').value = '';
            document.getElementById('tileImage').value = '';
            document.getElementById('tileButtonText').value = 'Learn More';
            document.getElementById('tileButtonLink').value = '';
            document.getElementById('tileModal').classList.add('active');
        }

        // Open edit tile modal
        function openEditTileModal(index, field) {
            editingTileIndex = index;
            const tile = tiles[index];

            document.getElementById('tileModalHeader').textContent = 'Edit Tile';
            document.getElementById('tileTitle').value = tile.title;
            document.getElementById('tileSubtitle').value = tile.subtitle;
            document.getElementById('tileImage').value = tile.image;
            document.getElementById('tileButtonText').value = tile.buttonText;
            document.getElementById('tileButtonLink').value = tile.buttonLink || '';
            document.getElementById('tileModal').classList.add('active');

            setTimeout(() => {
                if (field === 'title') document.getElementById('tileTitle').focus();
                else if (field === 'subtitle') document.getElementById('tileSubtitle').focus();
                else if (field === 'image') document.getElementById('tileImage').focus();
            }, 100);
        }

        // Close tile modal
        function closeTileModal() {
            document.getElementById('tileModal').classList.remove('active');
            editingTileIndex = null;
        }

        // Save tile
        function saveTile() {
            const title = document.getElementById('tileTitle').value.trim();
            const subtitle = document.getElementById('tileSubtitle').value.trim();
            const image = document.getElementById('tileImage').value.trim();
            const buttonText = document.getElementById('tileButtonText').value.trim() || 'Learn More';
            const buttonLink = document.getElementById('tileButtonLink').value.trim();

            if (!title) {
                alert('Please enter a title for the tile');
                return;
            }

            const tileData = {
                title,
                subtitle,
                image,
                buttonText,
                buttonLink
            };

            if (editingTileIndex !== null) {
                tiles[editingTileIndex] = tileData;
            } else {
                tiles.push(tileData);
            }

            renderTiles();
            updateURL();
            closeTileModal();
        }

        // Delete tile
        function deleteTile(index) {
            if (confirm('Are you sure you want to delete this tile?')) {
                tiles.splice(index, 1);
                renderTiles();
                updateURL();
            }
        }

        // Drag and drop functions
        function handleDragStart(e, index) {
            draggedTileIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
        }

        function handleDragOver(e, index) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetTile = e.currentTarget;
            if (!targetTile.classList.contains('dragging')) {
                targetTile.classList.add('drag-over');
            }

            return false;
        }

        function handleDragEnter(e, index) {
            const targetTile = e.currentTarget;
            if (!targetTile.classList.contains('dragging')) {
                targetTile.classList.add('drag-over');
            }
        }

        function handleDragLeave(e, index) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e, dropIndex) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            e.currentTarget.classList.remove('drag-over');

            if (draggedTileIndex !== dropIndex && draggedTileIndex !== null) {
                // Reorder tiles array
                const draggedTile = tiles[draggedTileIndex];
                tiles.splice(draggedTileIndex, 1);

                // Adjust drop index if dragging from before to after
                const newDropIndex = draggedTileIndex < dropIndex ? dropIndex - 1 : dropIndex;
                tiles.splice(newDropIndex, 0, draggedTile);

                renderTiles();
                updateURL();
            }

            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');

            // Remove drag-over class from all tiles
            document.querySelectorAll('.tile').forEach(tile => {
                tile.classList.remove('drag-over');
            });

            draggedTileIndex = null;
        }

        // Render tiles
        function renderTiles() {
            const grid = document.getElementById('tilesGrid');

            let html = '';

            tiles.forEach((tile, index) => {
                const imageHTML = tile.image 
                    ? `<img src="${escapeHtml(tile.image)}" class="tile-image" onclick="openEditTileModal(${index}, 'image')" alt="${escapeHtml(tile.title)}">`
                    : `<div class="tile-placeholder-image" onclick="openEditTileModal(${index}, 'image')">üñºÔ∏è</div>`;

                const buttonAction = tile.buttonLink 
                    ? `window.open('${escapeHtml(tile.buttonLink)}', '_blank')`
                    : `openEditTileModal(${index})`;

                html += `
                    <div class="tile" draggable="true" 
                         ondragstart="handleDragStart(event, ${index})"
                         ondragover="handleDragOver(event, ${index})"
                         ondragenter="handleDragEnter(event, ${index})"
                         ondragleave="handleDragLeave(event, ${index})"
                         ondrop="handleDrop(event, ${index})"
                         ondragend="handleDragEnd(event)">
                        <div class="tile-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</div>
                        <button class="tile-delete" onclick="deleteTile(${index})">√ó</button>
                        <div class="tile-image-container">
                            ${imageHTML}
                        </div>
                        <div class="tile-content">
                            <div class="tile-title" onclick="openEditTileModal(${index}, 'title')">${escapeHtml(tile.title)}</div>
                            <div class="tile-subtitle" onclick="openEditTileModal(${index}, 'subtitle')">${escapeHtml(tile.subtitle)}</div>
                            <button class="tile-button" onclick="${buttonAction}">${escapeHtml(tile.buttonText)}</button>
                        </div>
                    </div>
                `;
            });

            // Add new tile button
            html += `
                <div class="new-tile" onclick="openNewTileModal()">
                    <div class="new-tile-content">
                        <div class="new-tile-icon">+</div>
                        <div class="new-tile-text">Add New Tile</div>
                    </div>
                </div>
            `;

            grid.innerHTML = html;
        }

        // Update URL
        function updateURL() {
            const params = new URLSearchParams();

            if (pageSettings.title !== 'My Tile Dashboard') {
                params.set('pt', pageSettings.title);
            }
            if (pageSettings.logo !== 'üé®') {
                params.set('lg', pageSettings.logo);
            }
            if (pageSettings.favicon !== 'üé®') {
                params.set('fv', pageSettings.favicon);
            }

            if (tiles.length > 0) {
                const abbreviated = tilesToAbbreviated(tiles);
                params.set('d', JSON.stringify(abbreviated));
            }

            const newURL = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
            window.history.replaceState({}, '', newURL);

            console.log(`URL length: ${window.location.href.length} characters`);
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals on background click
        document.getElementById('tileModal').addEventListener('click', function(e) {
            if (e.target === this) closeTileModal();
        });

        document.getElementById('pageSettingsModal').addEventListener('click', function(e) {
            if (e.target === this) closePageSettingsModal();
        });

        // Load on page load
        window.addEventListener('DOMContentLoaded', loadFromURL);
    </script>
</body>
</html>
